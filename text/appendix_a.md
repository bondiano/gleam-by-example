# Telegram-–±–æ—Ç —Å Telega

> –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Telegram-–±–æ—Ç: –∫–æ–º–∞–Ω–¥—ã, —Ä–æ—É—Ç–µ—Ä, middleware, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Wisp –∏ PostgreSQL.

<!-- toc -->

## –¶–µ–ª–∏ –≥–ª–∞–≤—ã

–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –º—ã:

- –ü–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å Telega ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –¥–ª—è Telegram-–±–æ—Ç–æ–≤ –Ω–∞ Gleam
- –ù–∞—É—á–∏–º—Å—è —Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Å–≤–æ–∏–º **Session** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–∑—É—á–∏–º **Conversation API** ‚Äî –ª–∏–Ω–µ–π–Ω—ã–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —á–µ—Ä–µ–∑ `wait_*` —Ñ—É–Ω–∫—Ü–∏–∏
- –†–∞–∑–±–µ—Ä—ë–º **Flow API** ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –∫–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
- –ü–æ–π–º—ë–º, –∫–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ —Å Wisp —á–µ—Ä–µ–∑ webhook
- –†–∞—Å—Å–º–æ—Ç—Ä–∏–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, callback queries –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤–≤–æ–¥–∞
- –ü–æ—Å—Ç—Ä–æ–∏–º TODO-–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç Telegram-–±–æ—Ç—ã

Telegram –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: **long polling** –∏ **webhooks**. –í—ã–±–æ—Ä –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Äî –æ–¥–∏–Ω –∏–∑ –ø–µ—Ä–≤—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–æ—Ç–∞.

### Long Polling ‚Äî –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ

–ë–æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ Telegram: ¬´–µ—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è?¬ª. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ 30 —Å–µ–∫—É–Ω–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), –∑–∞—Ç–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è. –≠—Ç–æ **pull-–º–æ–¥–µ–ª—å**: –±–æ—Ç —Å–∞–º –∑–∞–±–∏—Ä–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

**–ü–ª—é—Å—ã:**

- –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ‚Äî –Ω–µ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π URL –∏–ª–∏ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –Ω–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∑–∞ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –ø—Ä–æ—â–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

**–ú–∏–Ω—É—Å—ã:**

- –í—ã—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å ‚Äî –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å 24/7, –Ω–µ–ª—å–∑—è "—Å–ø–∞—Ç—å" –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è serverless-–ø–ª–∞—Ç—Ñ–æ—Ä–º (AWS Lambda, Cloudflare Workers)

### Webhook ‚Äî —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ

Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏. –≠—Ç–æ **push-–º–æ–¥–µ–ª—å**: —Å–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç –±–æ—Ç—É –æ —Å–æ–±—ã—Ç–∏—è—Ö, –±–æ—Ç –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç.

**–ü–ª—é—Å—ã:**

- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ ‚Äî –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è serverless ‚Äî —Ñ—É–Ω–∫—Ü–∏—è "–ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è" —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ–±–ª–∞—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
- –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (–∏ –¥–µ–Ω–µ–≥) –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ú–∏–Ω—É—Å—ã:**

- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π URL —Å –≤–∞–ª–∏–¥–Ω—ã–º SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
- –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ö—Ä–∏—Ç–∏—á–Ω–æ:** Telegram –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ ~10 —Å–µ–∫—É–Ω–¥. –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Üí –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

**–í–∞–∂–Ω–æ –¥–ª—è webhook:** –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API, —Ç—è–∂—ë–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è) –Ω—É–∂–Ω–æ –≤—ã–Ω–æ—Å–∏—Ç—å –≤ —Ñ–æ–Ω–æ–≤—É—é –æ—á–µ—Ä–µ–¥—å. –û—Ç–≤–µ—á–∞–π—Ç–µ Telegram –±—ã—Å—Ç—Ä–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

### –ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
| -------- | ------------ |
| –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | Long polling |
| –ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç –Ω–∞ VPS/dedicated —Å–µ—Ä–≤–µ—Ä–µ | Long polling (–ø—Ä–æ—â–µ) |
| Serverless (Lambda, Workers) | Webhook (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) |
| –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ | Webhook |
| –ë–æ—Ç —Å —Å–µ—Å—Å–∏—è–º–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º | Long polling (–º–µ–Ω—å—à–µ race conditions) |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö:** –ù–∞—á–Ω–∏—Ç–µ —Å long polling ‚Äî –æ–Ω –ø—Ä–æ—â–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ webhook —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã (serverless, —ç–∫–æ–Ω–æ–º–∏—è).

Telega –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ä–µ–∂–∏–º–∞. –î–ª—è webhook –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–¥–∞–ø—Ç–µ—Ä `telega/adapters/wisp`, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º Wisp (–≥–ª–∞–≤–∞ 10).

## –ü–µ—Ä–≤—ã–π –±–æ—Ç

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:

```toml
[dependencies]
telega = ">= 0.1.0 and < 1.0.0"
wisp = ">= 1.0.0 and < 4.0.0"
mist = ">= 4.0.0 and < 6.0.0"
```

–ü—Ä–æ—Å—Ç–µ–π—à–∏–π —ç—Ö–æ-–±–æ—Ç ‚Äî –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

```gleam
// –†–æ—É—Ç–µ—Ä —Å –æ–¥–Ω–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º ‚Äî –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ö–æ–º
let bot_router =
  router.new("echo_bot")
  |> router.on_any_text(fn(ctx, text) {
    let assert Ok(_) = reply.with_text(ctx, text)
    Ok(ctx)
  })

// –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º —Å Wisp
let assert Ok(bot) =
  telega.new(token: "YOUR_BOT_TOKEN", url: "https://...", ...)
  |> telega.with_router(bot_router)
  |> telega.with_nil_session()
  |> telega.init()
```

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –∫–æ–¥ echo_bot.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/echo_bot.gleam)

</details>

–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–º –∂–µ —Ç–µ–∫—Å—Ç–æ–º –Ω–∞ –ª—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ —Ä–æ—É—Ç–µ—Ä.

## Router ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

`telega/router` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–∞. –†–æ—É—Ç–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, –∞ `telega.with_router` –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –µ–≥–æ –∫ –±–æ—Ç—É:

```gleam
let bot_router =
  router.new("my_bot")
  |> router.on_command("start", fn(ctx, _command) {
    let assert Ok(_) = reply.with_text(ctx, "–ü—Ä–∏–≤–µ—Ç! /help –¥–ª—è –ø–æ–º–æ—â–∏.")
    Ok(ctx)
  })

let assert Ok(bot) =
  telega.new(token: token, url: url, ...)
  |> telega.with_router(bot_router)
  |> telega.init()
```

`router.new("name")` —Å–æ–∑–¥–∞—ë—Ç –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä. –ö–∞–∂–¥—ã–π `|> router.on_command(...)` –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä ‚Äî —á–∏—Å—Ç–∞—è —Ü–µ–ø–æ—á–∫–∞ –±–µ–∑ –º—É—Ç–∞—Ü–∏–π.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã router_example.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/router_example.gleam)

</details>

### –ö–æ–º–∞–Ω–¥—ã

```gleam
import telega/reply
import telega/router

fn build_router() {
  router.new("my_bot")
  // /start
  |> router.on_command("start", fn(ctx, _command) {
    let assert Ok(_) = reply.with_text(ctx, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!")
    Ok(ctx)
  })
  // /help
  |> router.on_command("help", fn(ctx, _command) {
    let assert Ok(_) = reply.with_text(
      ctx,
      "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/start ‚Äî –Ω–∞—á–∞–ª–æ\n/help ‚Äî –ø–æ–º–æ—â—å\n/echo ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç",
    )
    Ok(ctx)
  })
}
```

–ö–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî –æ–±—ã—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `fn(ctx, command) -> Result(ctx, error)`. `_command` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥—ã (`command.command`, `command.payload`), –∑–¥–µ—Å—å –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω. –í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Ü–µ–ø–æ—á–∫–æ–π —á–µ—Ä–µ–∑ `|>`.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```gleam
// –õ—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî text –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
|> router.on_any_text(fn(ctx, text) {
  let assert Ok(_) = reply.with_text(ctx, "–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: " <> text)
  Ok(ctx)
})

// –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å "ping"
|> router.on_text(router.Exact("ping"), fn(ctx, _text) {
  let assert Ok(_) = reply.with_text(ctx, "pong!")
  Ok(ctx)
})
```

–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤—Ç–æ—Ä—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚Äî –Ω–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ `ctx` —á—Ç–æ–±—ã –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å. `router.on_text` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω: `Exact`, `Prefix`, `Contains` –∏–ª–∏ `Suffix`.

## Reply ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤

–ú–æ–¥—É–ª—å `telega/reply` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π:

```gleam
import telega/reply

// –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
let assert Ok(_) = reply.with_text(ctx, "–ü—Ä–∏–≤–µ—Ç!")

// –¢–µ–∫—Å—Ç —Å HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
let assert Ok(_) = reply.with_html(ctx, "<b>–ñ–∏—Ä–Ω—ã–π</b> —Ç–µ–∫—Å—Ç")

// –¢–µ–∫—Å—Ç —Å Markdown
let assert Ok(_) = reply.with_markdown(ctx, "*–ñ–∏—Ä–Ω—ã–π* —Ç–µ–∫—Å—Ç")
```

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ `reply.*` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `Result` ‚Äî –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ `assert Ok`. –û–Ω–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –æ—Ç–≤–µ—Ç –≤ —Ç–æ—Ç –∂–µ —á–∞—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–∏—à–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `ctx` —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞ –∏ –∫–ª–∏–µ–Ω—Ç –±–æ—Ç–∞.

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ fmt

–î–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä —É—Ç–∏–ª–∏—Ç `telega/format`:

```gleam
import telega/format as fmt
import telega/reply

fn send_welcome(ctx) {
  let message =
    fmt.build()
    |> fmt.bold_text("–ü—Ä–∏–≤–µ—Ç! ")
    |> fmt.text("–Ø TODO-–±–æ—Ç.")
    |> fmt.line_break()
    |> fmt.text("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /list –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á.")
    |> fmt.to_formatted()

  let assert Ok(_) = reply.with_formatted(ctx, message)
  Ok(ctx)
}
```

`fmt.build()` —Å–æ–∑–¥–∞—ë—Ç –±–∏–ª–¥–µ—Ä, –∫–∞–∂–¥—ã–π `|>` –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç. –í –∫–æ–Ω—Ü–µ `to_formatted()` —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–∂–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π.

### –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã: Inline vs Custom

Telegram –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É:

#### Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º)

Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è **–ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º** –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **callback query** ‚Äî –Ω–µ–≤–∏–¥–∏–º–æ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏–µ. –í —á–∞—Ç–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏–µ.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- –î–µ–π—Å—Ç–≤–∏—è –±–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫, –≤—ã–±–æ—Ä –æ–ø—Ü–∏–∏)
- –ò–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–î–∞/–ù–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)

**–ü—Ä–∏–º–µ—Ä:**

```gleam
import telega/keyboard
import telega/reply

fn send_settings_menu(ctx) {
  let kb =
    keyboard.inline_builder()
    |> keyboard.inline_button("üåç –ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫", keyboard.string_callback_data("lang"))
    |> keyboard.inline_button("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", keyboard.string_callback_data("notif"))
    |> keyboard.inline_row()  // –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–Ω–æ–ø–æ–∫
    |> keyboard.inline_button("‚ùå –ó–∞–∫—Ä—ã—Ç—å", keyboard.string_callback_data("close"))
    |> keyboard.inline_build()

  let assert Ok(_) = reply.with_markup(ctx, "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:", keyboard.inline_to_markup(kb))
  Ok(ctx)
}
```

–ö–Ω–æ–ø–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–∞—Ç—Å—è —Ç–∞–∫:

```
[üåç –ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫] [üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è]
         [‚ùå –ó–∞–∫—Ä—ã—Ç—å]
```

`inline_row()` –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–Ω–æ–ø–æ–∫. –ë–µ–∑ –Ω–µ–≥–æ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∏–¥—É—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É.

#### Custom-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∑–∞–º–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)

Custom-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã **–∑–∞–º–µ–Ω—è—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω–æ–µ **—Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**, –≤–∏–¥–∏–º–æ–µ –≤ —á–∞—Ç–µ. –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ = —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Å –≤–∏–¥–∏–º—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
- –ê–Ω–∫–µ—Ç—ã –∏ –æ–ø—Ä–æ—Å—ã (–æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞)
- –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ —Ç–∏–ø–∏—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (/start, /help)
- –ö–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª

**–ü—Ä–∏–º–µ—Ä:**

```gleam
import telega/keyboard
import telega/reply

fn ask_confirmation(ctx) {
  let kb =
    keyboard.custom_builder()
    |> keyboard.custom_button("‚úÖ –î–∞")
    |> keyboard.custom_button("‚ùå –ù–µ—Ç")
    |> keyboard.custom_row()
    |> keyboard.custom_button("‚ùì –ù–µ —É–≤–µ—Ä–µ–Ω")
    |> keyboard.custom_build(one_time: True, resize: True)

  let assert Ok(_) = reply.with_markup(ctx, "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", keyboard.custom_to_markup(kb))
  Ok(ctx)
}
```

`one_time: True` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏. `resize: True` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ (–∏–Ω–∞—á–µ –∑–∞–π–º—ë—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω).

#### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è

| –ê—Å–ø–µ–∫—Ç | Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | Custom-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ |
|--------|-------------------|-------------------|
| **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ** | –ü–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º | –í–º–µ—Å—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã |
| **–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** | Callback query (–Ω–µ–≤–∏–¥–∏–º–æ) | –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–∏–¥–∏–º–æ) |
| **–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ vs –¥–∞–Ω–Ω—ã–µ** | –ú–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å: —Ç–µ–∫—Å—Ç "–î–∞", –¥–∞–Ω–Ω—ã–µ "confirm_yes" | –û–¥–Ω–æ –∏ —Ç–æ –∂–µ: –∫–Ω–æ–ø–∫–∞ "–î–∞" ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ "–î–∞" |
| **–í–∏–¥–∏–º–æ—Å—Ç—å –≤ —á–∞—Ç–µ** | –ù–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è | –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞** | `wait_callback_query` –∏–ª–∏ `router.on_callback_query` | `wait_text` –∏–ª–∏ `router.on_text` |

**–í–∞–∂–Ω–æ:** –≠—Ç–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ ‚Äî –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–µ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä

Callback queries –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Conversation API (—Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª) –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Ä–æ—É—Ç–µ—Ä:

```gleam
router.new("settings_bot")
|> router.on_callback_query("lang", fn(ctx, query) {
  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
  let assert Ok(_) = reply.answer_callback_query(ctx, query.id, Some("–û—Ç–∫—Ä—ã–≤–∞—é..."))
  show_language_menu(ctx)
})
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π—Ç–µ `reply.answer_callback_query` ‚Äî –∏–Ω–∞—á–µ Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ custom-–∫–ª–∞–≤–∏–∞—Ç—É—Ä

Custom-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç:

```gleam
router.new("quiz_bot")
|> router.on_text(router.Exact("‚úÖ –î–∞"), fn(ctx, _) {
  reply.with_text(ctx, "–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º.")
})
```

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/keyboard_example.gleam)

</details>

## Session ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî —Ä—É—Å—Å–∫–∏–π. –û—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–º–∞–Ω–¥—É `/start`, –ø–æ–ª—É—á–∏–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ß–µ—Ä–µ–∑ —á–∞—Å –ø–∏—à–µ—Ç `/help` ‚Äî –∏ –±–æ—Ç —Å–Ω–æ–≤–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏. –ö–∞–∫ –±–æ—Ç "–ø–æ–º–Ω–∏—Ç" –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ HTTP-—Å–æ–±—ã—Ç–∏–µ. –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –±–æ—Ç –∑–∞–±—ã–≤–∞–µ—Ç –≤—Å—ë –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏. **–°–µ—Å—Å–∏–∏** —Ä–µ—à–∞—é—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É: —ç—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –ø–æ–¥ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–¥–µ –±–æ—Ç —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.

### –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Å–µ—Å—Å–∏–∏?

–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:

- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** —è–∑—ã–∫, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞, —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª –º–µ–Ω—é
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
- **–°—á—ë—Ç—á–∏–∫–∏:** —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ

**–í–∞–∂–Ω–æ:** –°–µ—Å—Å–∏–∏ –≤ Telega –∂–∏–≤—É—Ç –≤ –ø–∞–º—è—Ç–∏ BEAM-–ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ **–Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞**. –î–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ Flow API —Å Storage.

### –°–æ–∑–¥–∞—ë–º —Ç–∏–ø —Å–µ—Å—Å–∏–∏

–°–µ—Å—Å–∏—è ‚Äî —ç—Ç–æ –æ–±—ã—á–Ω—ã–π Gleam-—Ç–∏–ø. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —á—Ç–æ –≤–∞—à –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å –æ –∫–∞–∂–¥–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:

```gleam
pub type MusicBotSession {
  MusicBotSession(
    language: String,           // –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    favorite_genre: Option(String),  // –õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–¥–∞–Ω)
    plays_count: Int,           // –°–∫–æ–ª—å–∫–æ —Ç—Ä–µ–∫–æ–≤ –ø—Ä–æ—Å–ª—É—à–∞–Ω–æ
  )
}

// –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
pub fn default_session() -> MusicBotSession {
  MusicBotSession(
    language: "ru",
    favorite_genre: None,
    plays_count: 0,
  )
}
```

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é –∫–æ–ø–∏—é —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è A –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è B.

### –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–µ—Å—Å–∏–∏ –∫ –±–æ—Ç—É

–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞:

```gleam
import telega
import telega/session
import telega/router

pub fn build_bot(token: String, url: String) {
  let bot_router =
    router.new("music_bot")
    |> router.on_command("start", handle_start)
    |> router.on_command("lang", handle_change_language)

  let assert Ok(bot) =
    telega.new(token: token, url: url, webhook_path: "/bot", secret_token: None)
    |> telega.with_router(bot_router)
    |> session.attach(default_session)  // ‚Üê –ú–∞–≥–∏—è –∑–¥–µ—Å—å!
    |> telega.init()

  bot
}
```

`session.attach(default_session)` –≥–æ–≤–æ—Ä–∏—Ç Telega: "–î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–∑—ã–≤–∞–π `default_session()` –∏ —Ö—Ä–∞–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç". –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç user_id=12345 —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–µ—Å—Å–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è.

### –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Å—Å–∏–∏

–°–µ—Å—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ `ctx.session` –≤ –ª—é–±–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:

```gleam
import telega/bot.{type Context}
import telega/reply

fn handle_stats(ctx: Context(MusicBotSession, Nil), _command) {
  let plays = ctx.session.plays_count
  let genre = ctx.session.favorite_genre |> option.unwrap("–Ω–µ –≤—ã–±—Ä–∞–Ω")

  let message =
    "üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
    <> "üéµ –ü—Ä–æ—Å–ª—É—à–∞–Ω–æ —Ç—Ä–µ–∫–æ–≤: " <> int.to_string(plays) <> "\n"
    <> "‚ù§Ô∏è –õ—é–±–∏–º—ã–π –∂–∞–Ω—Ä: " <> genre

  let assert Ok(_) = reply.with_text(ctx, message)
  Ok(ctx)
}
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä—É: `Context(MusicBotSession, Nil)`. –ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∏–ø–∞ ‚Äî —Ç–∏–ø —Å–µ—Å—Å–∏–∏. –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ –≤—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª—è–º!

### –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é

–°–µ—Å—Å–∏–∏ **–∏–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã** ‚Äî —Å–æ–∑–¥–∞—ë–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ `bot.next_session`:

```gleam
fn handle_play_track(ctx: Context(MusicBotSession, Nil), _command) {
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —á–µ—Ä–µ–∑ spread-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å
  let updated = MusicBotSession(..ctx.session, plays_count: ctx.session.plays_count + 1)

  let assert Ok(_) = reply.with_text(ctx, "üé∂ –¢—Ä–µ–∫ –Ω–∞—á–∞–ª –∏–≥—Ä–∞—Ç—å!")
  bot.next_session(ctx, updated)
}
```

**Spread-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å** `..ctx.session` –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ª—è, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Å—Å–∏—è–º–∏</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/session_example.gleam)

</details>

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ (–∏ –∫–æ–≥–¥–∞ –Ω–µ—Ç)

Session ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º **–≤ –ø–∞–º—è—Ç–∏**. –í—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∑–∞–¥–∞—á–∏:

| –ó–∞–¥–∞—á–∞ | –†–µ—à–µ–Ω–∏–µ | –ü–æ—á–µ–º—É |
|--------|---------|--------|
| –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ | ‚úÖ Session | –ß–∏—Ç–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ, —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è |
| –°—á—ë—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) | ‚úÖ Session | –ë—ã—Å—Ç—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ |
| –¢–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª –º–µ–Ω—é | ‚úÖ Session | –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ |
| –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–∏–º—è, email, –≤–æ–∑—Ä–∞—Å—Ç) | ‚ùå Conversation API | –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π |
| –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ | ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ–ª—å–∑—è –ø–æ—Ç–µ—Ä—è—Ç—å |
| –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚ùå Flow + Storage | –ù—É–∂–Ω–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –Ω–∞–≤–∏–≥–∞—Ü–∏—è "–Ω–∞–∑–∞–¥" |
| –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ | ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ |

**–≠–º–ø–∏—Ä–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**

- Session ‚Äî –¥–ª—è **—ç—Ñ–µ–º–µ—Ä–Ω—ã—Ö** –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ—Ç–µ—Ä—è—Ç—å –±–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî –¥–ª—è **–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –ø–æ—Ç–µ—Ä—è—Ç—å
- Conversation/Flow ‚Äî –¥–ª—è **–ø—Ä–æ—Ü–µ—Å—Å–æ–≤** —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏

**–ü—Ä–∏–º–µ—Ä –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω–∞:**

```gleam
// ‚ùå –ü–õ–û–•–û: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏
pub type BadSession {
  BadSession(
    shopping_cart: List(CartItem),  // –ü–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ!
    payment_token: String,          // –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏!
    order_history: List(Order),     // –†–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ!
  )
}

// ‚úÖ –•–û–†–û–®–û: —ç—Ñ–µ–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏
pub type GoodSession {
  GoodSession(
    language: String,               // –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    current_menu: MenuSection,      // –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    view_mode: ViewMode,            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  )
}
```

**–õ–∞–π—Ñ—Ö–∞–∫:** –ï—Å–ª–∏ –∑–∞–¥–∞—ë—Ç–µ —Å–µ–±–µ –≤–æ–ø—Ä–æ—Å "—á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?", –∏ –æ—Ç–≤–µ—Ç "–Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Session. –ï—Å–ª–∏ "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ" ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ Flow.

## Conversation API ‚Äî –ª–∏–Ω–µ–π–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏

Conversation API –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è" –Ω–∞ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `wait_*` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

### –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑. Conversation API –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥:

```gleam
import telega/bot.{type Context}
import telega/reply

// –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
fn handle_echo(ctx, text) {
  reply.with_text(ctx, "–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: " <> text)
}

// Conversation API ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
fn handle_name_conversation(ctx: Context(Nil, Nil), _command) {
  use ctx <- reply.with_text(ctx, "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
  use ctx, name <- wait_text(ctx, or: None, timeout: None)

  use ctx <- reply.with_text(ctx, "–°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?")
  use ctx, age_str <- wait_text(ctx, or: None, timeout: None)

  reply.with_text(ctx, "–ü—Ä–∏–≤–µ—Ç, " <> name <> "! –í–∞–º " <> age_str <> " –ª–µ—Ç.")
}
```

–ö–∞–∂–¥—ã–π `use ctx, value <- wait_*` –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ. BEAM —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

### –§—É–Ω–∫—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

**–ë–∞–∑–æ–≤—ã–µ wait-—Ñ—É–Ω–∫—Ü–∏–∏:**

```gleam
import telega/bot.{wait_text, wait_callback_query, wait_command}

// –õ—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
use ctx, text <- wait_text(ctx, or: None, timeout: None)

// –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
use ctx, cmd <- wait_command(ctx, "cancel", or: None, timeout: None)

// –ù–∞–∂–∞—Ç–∏–µ inline-–∫–Ω–æ–ø–∫–∏
use ctx, callback_data <- wait_callback_query(ctx, or: None, timeout: None)
```

–í—Å–µ `wait_*` —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç:

- `ctx` ‚Äî —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- `or` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (`Some(handler)` –∏–ª–∏ `None`)
- `timeout` ‚Äî —Ç–∞–π–º-–∞—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (`Some(60_000)` –∏–ª–∏ `None`)

### Forms API ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞

Conversation API –≤–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π:

```gleam
import telega/bot.{wait_number, wait_email, wait_choice}

// –ß–∏—Å–ª–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω–∞
use ctx, age <- wait_number(
  ctx,
  min: Some(13),
  max: Some(120),
  or: Some(bot.HandleText(fn(ctx, invalid) {
    reply.with_text(ctx, "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 13 –¥–æ 120")
  })),
  timeout: None,
)

// Email —Å regex-–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
use ctx, email <- wait_email(
  ctx,
  or: Some(bot.HandleText(fn(ctx, invalid) {
    reply.with_text(ctx, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
  })),
  timeout: None,
)

// –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
pub type Plan {
  Free
  Premium
}

use ctx, plan <- wait_choice(
  ctx,
  [#("üÜì Free", Free), #("üíé Premium", Premium)],
  or: None,
  timeout: None,
)
```

`wait_number` –ø–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –≤ `Int` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω. `wait_email` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ regex. `wait_choice` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º-–∞—É—Ç–æ–≤

–ü–∞—Ä–∞–º–µ—Ç—Ä `or` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```gleam
use ctx, age <- wait_number(
  ctx,
  min: Some(18),
  max: Some(100),
  or: Some(bot.HandleAny(fn(ctx, update) {
    case update {
      bot.TextMessage(text) -> {
        let assert Ok(_) = reply.with_text(ctx, "–≠—Ç–æ –Ω–µ —á–∏—Å–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        // –ñ–¥—ë–º –≤–≤–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
        wait_number(ctx, min: Some(18), max: Some(100), or: None, timeout: None)
      }
      bot.CommandMessage("cancel", _) -> {
        let assert Ok(_) = reply.with_text(ctx, "–û—Ç–º–µ–Ω–µ–Ω–æ.")
        Ok(ctx)
      }
      _ -> {
        let assert Ok(_) = reply.with_text(ctx, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ –∏–ª–∏ /cancel")
        wait_number(ctx, min: Some(18), max: Some(100), or: None, timeout: None)
      }
    }
  })),
  timeout: Some(60_000),  // 60 —Å–µ–∫—É–Ω–¥
)
```

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç –∑–∞ `timeout` –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥, –¥–∏–∞–ª–æ–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è.

### –ü—Ä–∏–º–µ—Ä: —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

```gleam
fn handle_register(ctx, _command) {
  use ctx <- reply.with_text(ctx, "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
  use ctx, name <- wait_text(ctx, or: None, timeout: Some(120_000))

  use ctx, age <- wait_number(ctx, min: Some(13), max: Some(120), ...)
  use ctx, email <- wait_email(ctx, ...)
  use ctx, plan <- wait_choice(ctx, [#("üÜì Free", Free), #("üíé Premium", Premium)], ...)

  db.save_user(name, age, email, plan)
  reply.with_text(ctx, "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
}
```

–í–µ—Å—å –¥–∏–∞–ª–æ–≥ ‚Äî –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ —è–≤–Ω–æ–≥–æ FSM. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–∞, –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `or`, —Ç–∞–π–º-–∞—É—Ç—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/conversation_example.gleam)

</details>

### –û–∂–∏–¥–∞–Ω–∏–µ callback queries

–î–ª—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `wait_callback_query`:

```gleam
import telega/keyboard
import telega/model/types.{AnswerCallbackQueryParameters}

fn handle_menu(ctx: Context(Nil, Nil), _command) {
  let kb =
    keyboard.inline_builder()
    |> keyboard.inline_button("–°–ø–∏—Å–æ–∫", keyboard.string_callback_data("list"))
    |> keyboard.inline_button("–î–æ–±–∞–≤–∏—Ç—å", keyboard.string_callback_data("add"))
    |> keyboard.inline_build()

  use ctx <- reply.with_markup(ctx, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", keyboard.inline_to_markup(kb))

  let assert Ok(filter) = keyboard.filter_inline_keyboard_query(kb)

  // –û–∂–∏–¥–∞–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
  use ctx, payload, query_id <- wait_callback_query(
    ctx,
    filter: Some(filter),
    or: None,
    timeout: Some(30_000),
  )

  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
  let assert Ok(_) = reply.answer_callback_query(
    ctx,
    AnswerCallbackQueryParameters(
      callback_query_id: query_id,
      text: Some("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."),
      show_alert: None,
      url: None,
      cache_time: None,
    ),
  )

  case payload {
    "list" -> show_list(ctx)
    "add" -> handle_add_conversation(ctx)
    _ -> reply.with_text(ctx, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")
  }
}
```

`reply.answer_callback_query` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî Telegram –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É.

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Conversation API

**‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Conversation API –∫–æ–≥–¥–∞:**

- –õ–∏–Ω–µ–π–Ω—ã–π –¥–∏–∞–ª–æ–≥ (2-5 —à–∞–≥–æ–≤)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø–æ–≤—Ç–æ—Ä–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ù–µ –Ω—É–∂–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è "–Ω–∞–∑–∞–¥"
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ)
- –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Conversation API –∫–æ–≥–¥–∞:**

- –°–ª–æ–∂–Ω–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (–º–Ω–æ–≥–æ —É—Å–ª–æ–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤)
- –ù—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
- –î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Flow + Subflows)

‚Üí –í —ç—Ç–∏—Ö —Å–ª—É—á–∞—è—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Flow API**

## –ö–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã (FSM) –≤ –±–æ—Ç–∞—Ö

Conversation API —É–¥–æ–±–µ–Ω –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤, –Ω–æ —É –Ω–µ–≥–æ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- –ù–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ "–Ω–∞–∑–∞–¥" –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ (–Ω–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
- –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–µ—è–≤–Ω–∞—è ‚Äî —Å–ª–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤—Å—é –∫–∞—Ä—Ç–∏–Ω—É –¥–∏–∞–ª–æ–≥–∞
- –°–ª–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

–ö–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã (Finite State Machines, FSM) —Ä–µ—à–∞—é—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã. FSM ‚Äî —ç—Ç–æ –º–æ–¥–µ–ª—å, –≥–¥–µ –µ—Å—Ç—å –∫–æ–Ω–µ—á–Ω–æ–µ —á–∏—Å–ª–æ **—Å–æ—Å—Ç–æ—è–Ω–∏–π** –∏ **–ø–µ—Ä–µ—Ö–æ–¥—ã** –º–µ–∂–¥—É –Ω–∏–º–∏ –ø–æ —Å–æ–±—ã—Ç–∏—è–º:

```
Y(t) = f(X(t), Y(t‚àí1))
```

–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç `t` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ö–æ–¥–∞ –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –í–∞–∂–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ: —É FSM –Ω–µ—Ç ¬´–ª–µ–Ω—Ç—ã¬ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç—ã –ø—Ä–æ—Å—Ç—ã–º–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏.

### –ó–∞—á–µ–º —è–≤–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è?

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –≤ –∫–æ–¥–µ –±–µ–∑ FSM:

```gleam
type UserSession {
  UserSession(
    is_waiting_name: Bool,
    is_waiting_phone: Bool,
    is_waiting_email: Bool,
    has_confirmed: Bool,
    is_cancelled: Bool,
    // ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
  )
}
```

–ú–æ–∑–≥ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏. –ê —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –æ–¥–∏–Ω —Ç–∏–ø, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤–∏–¥–Ω—ã **–≤—Å–µ** –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

```gleam
type RegistrationState {
  Idle
  AwaitingName
  AwaitingPhone
  AwaitingEmail
  Confirming
  Completed
  Cancelled
}
```

–°—Ä–∞–∑—É –ø–æ–Ω—è—Ç–Ω–æ, –≤ –∫–∞–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è. –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã.

–ß—Ç–æ –¥–∞—ë—Ç —è–≤–Ω—ã–π FSM:

- **–Ø—Å–Ω–æ—Å—Ç—å** ‚Äî –≤—Å—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- **–ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤** ‚Äî –Ω–µ–ª—å–∑—è —Å–ª—É—á–∞–π–Ω–æ –ø–æ–ø–∞—Å—Ç—å –≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å** ‚Äî –Ω–æ–≤—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–∏–Ω—É
- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

### State explosion –∏ statecharts

–ì–ª–∞–≤–Ω–∞—è –±–æ–ª—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö FSM ‚Äî *–≤–∑—Ä—ã–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π*. –î–æ–±–∞–≤–ª—è–µ—Ç–µ –æ–¥–∏–Ω –Ω–æ–≤—ã–π –∞—Å–ø–µ–∫—Ç, –∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä–∞—Å—Ç—ë—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ.

–ü—Ä–∏–º–µ—Ä ‚Äî —Ñ–æ—Ä–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

1. –ù–∞—á–∏–Ω–∞–µ–º —Å –¥–≤—É—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π: `Valid`, `Invalid`
2. –î–æ–±–∞–≤–∏–ª–∏ `Enabled`, `Disabled` ‚Äî —É–∂–µ 4 —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. –î–æ–±–∞–≤–∏–ª–∏ `Dirty`, `Pristine` ‚Äî 8 —Å–æ—Å—Ç–æ—è–Ω–∏–π

–í 1987 –≥–æ–¥—É –î—ç–≤–∏–¥ –•–∞—Ä–µ–ª –ø—Ä–∏–¥—É–º–∞–ª **statecharts** ‚Äî —ç—Ç–æ FSM –Ω–∞ —Å—Ç–µ—Ä–æ–∏–¥–∞—Ö:

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã** ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∞—Å–ø–µ–∫—Ç—ã –º–æ–¥–µ–ª–∏—Ä—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- **–ò–µ—Ä–∞—Ä—Ö–∏—è** ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏
- **Guards** ‚Äî —É—Å–ª–æ–≤–∏—è –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö

Telega Flow API —Ä–µ–∞–ª–∏–∑—É–µ—Ç —ç—Ç–∏ –∏–¥–µ–∏ –¥–ª—è Telegram-–±–æ—Ç–æ–≤.

## Flows API ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ FSM

`telega/flow` ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∫–∞–∫ FSM. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Conversation API, Flow –¥–∞—ë—Ç:

- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- **–ù–∞–≤–∏–≥–∞—Ü–∏—é** ‚Äî –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥ –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –ª—é–±–æ–º—É —à–∞–≥—É
- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî —à–∞–≥–∏ –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ ADT, –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–Ω–æ—Ç—É
- **–ö–æ–º–ø–æ–∑–∏—Ü–∏—é** ‚Äî –º–æ–∂–Ω–æ –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ–¥–Ω–∏ flows –≤ –¥—Ä—É–≥–∏–µ (subflows)

### –°–æ–∑–¥–∞–Ω–∏–µ Flow

Flow —Å—Ç—Ä–æ–∏—Ç—Å—è –∫–∞–∫ pipeline:

```gleam
import telega/flow
import gleam/option.{None, Some}

type RegistrationStep {
  Welcome
  CollectName
  CollectPhone
  CollectEmail
  Confirm
}

pub fn create_registration_flow(storage) {
  flow.new("registration")
  |> flow.with_storage(storage)
  |> flow.add_step(Welcome, welcome_step)
  |> flow.add_step(CollectName, collect_name_step)
  |> flow.add_step(CollectPhone, collect_phone_step)
  |> flow.add_step(CollectEmail, collect_email_step)
  |> flow.add_step(Confirm, confirm_step)
  |> flow.on_complete(fn(ctx, instance) {
    let assert Ok(_) = reply.with_text(ctx, "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    Ok(ctx)
  })
  |> flow.build(initial: Welcome)
}
```

–ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `fn(Context, FlowInstance) -> FlowStepResult`:

```gleam
fn collect_name_step(ctx, instance) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  case flow.get_step_data(instance, "input") {
    Some(name) -> {
      // –í–∞–ª–∏–¥–∏—Ä—É–µ–º
      case validate_name(name) {
        Ok(valid_name) -> {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ instance –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ
          let instance = flow.store_data(instance, "name", valid_name)
          flow.next(ctx, instance, CollectPhone)
        }
        Error(msg) -> {
          let assert Ok(_) = reply.with_text(ctx, "–û—à–∏–±–∫–∞: " <> msg)
          // –ñ–¥—ë–º –≤–≤–æ–¥ —Å–Ω–æ–≤–∞
          flow.wait(ctx, instance, "input")
        }
      }
    }
    None -> {
      // –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –≤ —à–∞–≥ ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      let assert Ok(_) = reply.with_text(ctx, "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
      flow.wait(ctx, instance, "input")
    }
  }
}
```

### –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏

```gleam
// –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
flow.next(ctx, instance, CollectPhone)

// –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥
flow.back(ctx, instance)

// –ü—Ä—ã–∂–æ–∫ –∫ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É —à–∞–≥—É
flow.goto(ctx, instance, Confirm)

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ flow
flow.complete(ctx, instance)

// –û—Ç–º–µ–Ω–∞ flow
flow.cancel(ctx, instance)
```

`flow.back` –≤–æ–∑–º–æ–∂–µ–Ω –ø–æ—Ç–æ–º—É —á—Ç–æ Flow —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é —à–∞–≥–æ–≤ ‚Äî —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ call stack.

### Storage ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

Flow —Ç—Ä–µ–±—É–µ—Ç storage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ –±–æ—Ç–∞:

```gleam
import telega/flow/storage

// –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî in-memory
let storage = storage.memory()

// –î–ª—è production ‚Äî PostgreSQL —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
pub type FlowStorage {
  FlowStorage(
    save: fn(flow.Instance) -> Result(Nil, error),
    load: fn(String) -> Result(Option(flow.Instance), error),
    delete: fn(String) -> Result(Nil, error),
  )
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è PostgreSQL
pub fn create_db_storage(db: pog.Connection) -> FlowStorage {
  FlowStorage(
    save: fn(instance) {
      sql.save_flow_instance(db, instance)
    },
    load: fn(id) {
      sql.load_flow_instance(db, id)
    },
    delete: fn(id) {
      sql.delete_flow_instance(db, id)
    },
  )
}
```

Flow –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞. –ï—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –∂–µ —à–∞–≥–∞.

### Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ Flow

Flow –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ callback queries:

```gleam
fn confirm_step(ctx, instance) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–Ω–æ–ø–∫—É
  case flow.is_callback_passed(instance, "confirm_action") {
    Some("yes") -> {
      let assert Ok(_) = reply.with_text(ctx, "–û—Ç–ª–∏—á–Ω–æ!")
      flow.complete(ctx, instance)
    }
    Some("no") -> {
      let assert Ok(_) = reply.with_text(ctx, "–ù–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞.")
      flow.goto(ctx, instance, CollectName)
    }
    None -> {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
      let callback_data = keyboard.string_callback_data("confirm_action")

      let assert Ok(yes_btn) = keyboard.inline_button(
        "–î–∞",
        keyboard.pack_callback(callback_data, "yes"),
      )
      let assert Ok(no_btn) = keyboard.inline_button(
        "–ù–µ—Ç",
        keyboard.pack_callback(callback_data, "no"),
      )

      let kb = keyboard.new_inline([[yes_btn, no_btn]])
      let assert Ok(_) = reply.with_markup(ctx, "–í—Å—ë –≤–µ—Ä–Ω–æ?", keyboard.to_inline_markup(kb))

      // –ñ–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
      flow.wait_callback(ctx, instance, "confirm_action")
    }
  }
}
```

### Subflows ‚Äî –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–æ–≤

Subflows –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É:

```gleam
// Subflow –¥–ª—è —Å–±–æ—Ä–∞ –∞–¥—Ä–µ—Å–∞
let address_flow =
  flow.new("address")
  |> flow.with_storage(storage)
  |> flow.add_step(Street, street_step)
  |> flow.add_step(City, city_step)
  |> flow.add_step(Postal, postal_step)
  |> flow.build(initial: Street)

// –û—Å–Ω–æ–≤–Ω–æ–π flow –≤–∫–ª—é—á–∞–µ—Ç subflow
let checkout_flow =
  flow.new("checkout")
  |> flow.with_storage(storage)
  |> flow.add_step(Cart, cart_step)
  |> flow.add_subflow(
    trigger: CollectAddress,
    subflow: address_flow,
    return_to: Payment,
  )
  |> flow.add_step(Payment, payment_step)
  |> flow.build(initial: Cart)
```

–ö–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–Ω–æ–π flow –¥–æ—Ö–æ–¥–∏—Ç –¥–æ `CollectAddress`, –æ–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç `address_flow`. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è subflow —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —à–∞–≥—É `Payment`.

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Flow –≤ —Ä–æ—É—Ç–µ—Ä–µ

Flow —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã:

```gleam
import telega/flow

let registration_flow = create_registration_flow(storage)
let booking_flow = create_booking_flow(storage)

let flow_registry =
  flow.new_registry()
  |> flow.register(flow.OnCommand("start"), registration_flow)
  |> flow.register(flow.OnCommand("book"), booking_flow)

let router =
  router.new("restaurant_bot")
  |> router.on_command("help", handle_help)
  |> flow.apply_to_router(flow_registry)
```

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `registration_flow`. –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π flow, –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è.

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Flow

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–¥—Ö–æ–¥ |
|----------|--------|
| –ü—Ä–æ—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ —ç—Ö–æ | Router |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | Session |
| –õ–∏–Ω–µ–π–Ω—ã–π –¥–∏–∞–ª–æ–≥ (2-5 —à–∞–≥–æ–≤) | Conversation API |
| –î–∏–∞–ª–æ–≥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π | Conversation API (wait_number, wait_email) |
| –î–∏–∞–ª–æ–≥ —Å –≤–µ—Ç–≤–ª–µ–Ω–∏—è–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –Ω–∞–∑–∞–¥ | Flow |
| –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ | Flow + Storage |
| –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —á–∞—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞ | Flow + Subflows |

Flow ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏. –û–Ω —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Ç–µ—Ö –∂–µ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤ (Handler, Context, wait_*), –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç FSM-–º–æ–¥–µ–ª—å —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π.

## Middleware –≤ Telega

Telega –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç middleware –≤ –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞—Ö (–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å HTTP-–∑–∞–ø—Ä–æ—Å–∞–º–∏), middleware –≤ Telega –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç **–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞** ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∏–ø–∞ `fn(Context, Data) -> Result(Context, Error)`.

–°–∏–≥–Ω–∞—Ç—É—Ä–∞ middleware:

```gleam
pub type Middleware(session, error) =
  fn(Handler(session, error)) -> Handler(session, error)
```

Middleware –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ —Ä–æ—É—Ç–µ—Ä—É –∏ –≤–ª–∏—è—é—Ç –Ω–∞ –≤—Å–µ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.

### with_logging ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥–æ–µ –≤—Ö–æ–¥—è—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

```gleam
import telega/router

let bot_router =
  router.new("my_bot")
  |> router.with_logging()  // –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  |> router.on_command("start", handle_start)
  |> router.on_any_text(handle_text)
```

–ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

### with_filter ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É ‚Äî –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è:

```gleam
import telega/filter
import telega/router

// –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const admin_ids = [123456789, 987654321]

let admin_filter = filter.user_id(admin_ids)

let admin_router =
  router.new("admin")
  |> router.with_filter(admin_filter)  // –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
  |> router.on_command("stats", handle_stats)
  |> router.on_command("ban", handle_ban)
```

–¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥—ã `/stats` –∏ `/ban` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ `admin_ids`. –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.

**–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:**

```gleam
import telega/filter

// –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º ID
let combined =
  filter.text()
  |> filter.and(filter.user_id([12345]))

// –°–æ–æ–±—â–µ–Ω–∏—è –ò–õ–ò –æ—Ç –∞–¥–º–∏–Ω–æ–≤, –ò–õ–ò –∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
let either =
  filter.user_id(admin_ids)
  |> filter.or(filter.group_chat())
```

–§–∏–ª—å—Ç—Ä—ã ‚Äî —ç—Ç–æ –∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º—ã–µ –ø—Ä–µ–¥–∏–∫–∞—Ç—ã: `and()`, `or()`, `not()` –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ.

### with_recovery ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∏ –≤—ã–∑—ã–≤–∞–µ—Ç fallback-—Ñ—É–Ω–∫—Ü–∏—é:

```gleam
import telega/router
import telega/reply

let bot_router =
  router.new("my_bot")
  |> router.with_recovery(fn(error) {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    io.println("Handler error: " <> string.inspect(error))

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º Error –¥–ª—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏
    Error(error)
  })
  |> router.on_command("start", handle_start)
```

–ï—Å–ª–∏ `handle_start` –≤–µ—Ä–Ω—ë—Ç `Error`, middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç –æ—à–∏–±–∫—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç fallback. –í—ã –º–æ–∂–µ—Ç–µ:
- –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
- –í–µ—Ä–Ω—É—Ç—å `Ok(ctx)` –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–ª–∏ `Error(e)` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

### –ö–æ–º–ø–æ–∑–∏—Ü–∏—è middleware

Middleware –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–∑–æ–≤–∞:

```gleam
let bot_router =
  router.new("my_bot")
  |> router.with_logging()           // 1. –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  |> router.with_filter(admin_filter) // 2. –ó–∞—Ç–µ–º —Ñ–∏–ª—å—Ç—Ä
  |> router.with_recovery(handle_error) // 3. –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  |> router.on_command("start", handle_start)
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É middleware —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —Ñ–∏–ª—å—Ç—Ä ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚Üí –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Wisp (webhook)

Telega –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Wisp —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä `telega/adapters/wisp`:

```gleam
import mist
import telega/adapters/wisp as telega_wisp
import wisp
import wisp/wisp_mist

fn handle_request(bot, req) {
  // Wisp middleware –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
  use <- wisp.log_request(req)
  use <- wisp.rescue_crashes

  // Telega –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç webhook-–ø—É—Ç—å (/bot)
  use <- telega_wisp.handle_bot(bot, req)

  // –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –æ–±—ã—á–Ω—ã–µ HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
  case wisp.path_segments(req) {
    ["health"] -> wisp.ok()
    _ -> wisp.not_found()
  }
}

pub fn main() {
  wisp.configure_logger()

  let assert Ok(bot) = build_bot()

  let assert Ok(_) =
    wisp_mist.handler(fn(req) { handle_request(bot, req) }, "secret_key_base")
    |> mist.new
    |> mist.port(8080)
    |> mist.start

  process.sleep_forever()
}
```

`telega_wisp.handle_bot` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ webhook-–ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/bot`) –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö —Ä–æ—É—Ç–µ—Ä—É –±–æ—Ç–∞. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –¥–∞–ª—å—à–µ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è health-checks, –º–µ—Ç—Ä–∏–∫, –∞–¥–º–∏–Ω–∫–∏.

**–í–∞–∂–Ω–æ:** Middleware –≤ Wisp (`wisp.log_request`, `wisp.rescue_crashes`) —Ä–∞–±–æ—Ç–∞—é—Ç —Å **HTTP-–∑–∞–ø—Ä–æ—Å–∞–º–∏**. Middleware –≤ Telega (`router.with_logging`, `router.with_filter`) —Ä–∞–±–æ—Ç–∞—é—Ç —Å **–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –±–æ—Ç–∞**. –≠—Ç–æ –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —É—Ä–æ–≤–Ω—è.

## –ü—Ä–æ–µ–∫—Ç: TODO-–±–æ—Ç

–°–æ–±–µ—Ä—ë–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

### –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
| --------- | ---------- |
| `/start` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ |
| `/help` | –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ |
| `/list` | –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ |
| `/add <–∑–∞–¥–∞—á–∞>` | –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É |
| `/done <–Ω–æ–º–µ—Ä>` | –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é |
| `/clear` | –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ app.gleam          ‚Üê —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, main —Ñ—É–Ω–∫—Ü–∏—è
‚îú‚îÄ‚îÄ bot.gleam          ‚Üê –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –∏ —Ä–æ—É—Ç–µ—Ä–∞
‚îú‚îÄ‚îÄ db.gleam           ‚Üê —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL (pog)
‚îî‚îÄ‚îÄ handlers/
    ‚îú‚îÄ‚îÄ start.gleam    ‚Üê /start, /help
    ‚îî‚îÄ‚îÄ todos.gleam    ‚Üê /list, /add (—Å Conversation API), /done, /clear
```

–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏ –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å–ª–æ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º: `handlers/` —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, `db.gleam` ‚Äî —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, `bot.gleam` ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é. –ß–∏—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –≤ `handlers/` –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ Telegram-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

### bot.gleam

–ö–ª—é—á–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ—É—Ç–µ—Ä–∞:

```gleam
pub fn build(db_conn: pog.Connection) -> Result(telega.Telega(Nil, Nil), String) {
  let bot_router =
    router.new("todo_bot")
    |> router.on_command("start", fn(ctx, _) { reply.with_text(ctx, "–ü—Ä–∏–≤–µ—Ç!") })
    |> router.on_command("list", fn(ctx, _) { todos.handle_list(ctx, db_conn) })
    |> router.on_command("add", fn(ctx, _) { todos.handle_add_conversation(ctx, db_conn) })
    |> router.on_command("done", fn(ctx, cmd) { todos.handle_done(ctx, db_conn, cmd) })

  use bot <- result.try(
    telega.new(token: ..., url: ..., ...)
    |> telega.with_router(bot_router)
    |> telega.init()
  )
  Ok(bot)
}
```

–†–æ—É—Ç–µ—Ä —Å—Ç—Ä–æ–∏—Ç—Å—è —Ü–µ–ø–æ—á–∫–æ–π `|>`. –ó–∞–º—ã–∫–∞–Ω–∏–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç `db_conn`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–≥–æ –≤ –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –∫–æ–¥ bot.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/todo_bot/bot.gleam)

</details>

### handlers/todos.gleam

–ö–ª—é—á–µ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å Conversation API:

```gleam
// –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ Conversation API
pub fn handle_add_conversation(ctx, db_conn) {
  use ctx <- reply.with_text(ctx, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:")
  use ctx, title <- wait_text(ctx, or: None, timeout: Some(60_000))

  case string.trim(title) {
    "" -> reply.with_text(ctx, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ")
    valid -> {
      db.create_todo(db_conn, user_id, valid)
      reply.with_text(ctx, "‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
    }
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
pub fn handle_list(ctx, db_conn) {
  case db.list_user_todos(db_conn, user_id) {
    Ok(todos) -> {
      let lines = todos |> list.index_map(format_todo) |> string.join("\n")
      reply.with_text(ctx, "–í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n\n" <> lines)
    }
    _ -> reply.with_text(ctx, "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç")
  }
}
```

**–ö–ª—é—á–µ–≤–æ–µ:** `handle_add_conversation` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Conversation API ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `wait_text`, –¥–µ–ª–∞—è –∫–æ–¥ –ª–∏–Ω–µ–π–Ω—ã–º.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –∫–æ–¥ handlers/todos.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/todo_bot/handlers/todos.gleam)

</details>

### app.gleam

–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Wisp:

```gleam
pub fn main() {
  wisp.configure_logger()
  let db_conn = db.connect()
  let assert Ok(_) = db.create_schema(db_conn)
  let assert Ok(bot) = bot.build(db_conn)

  wisp_mist.handler(handle_request(bot, _), "secret")
  |> mist.new |> mist.port(8080) |> mist.start
  process.sleep_forever()
}

fn handle_request(bot, req) {
  use <- telega_wisp.handle_bot(bot, req)
  wisp.not_found()
}
```

`db.connect()` ‚Üí PostgreSQL, `bot.build()` ‚Üí —Ä–æ—É—Ç–µ—Ä, `telega_wisp.handle_bot()` ‚Üí –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç `/bot`.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –∫–æ–¥ app.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/todo_bot/app.gleam)

</details>

### db.gleam

–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL —á–µ—Ä–µ–∑ `pog`:

```gleam
pub type Todo {
  Todo(id: Int, user_id: Int, title: String, completed: Bool)
}

pub fn connect() -> pog.Connection {
  pog.default_config()
  |> pog.host(os.get_env("DB_HOST") |> result.unwrap("localhost"))
  |> pog.database("todos_bot")
  |> pog.connect
}

pub fn create_todo(db, user_id, title) -> Result(Nil, pog.QueryError) {
  pog.execute(
    "INSERT INTO todos (user_id, title) VALUES ($1, $2)",
    db,
    [pog.int(user_id), pog.text(title)],
    dynamic.dynamic
  )
}

pub fn list_user_todos(db, user_id) -> Result(List(Todo), pog.QueryError) {
  pog.execute(
    "SELECT id, user_id, title, completed FROM todos WHERE user_id = $1",
    db,
    [pog.int(user_id)],
    decode_todo
  )
  |> result.map(fn(response) { response.rows })
}
```

–ú–æ–¥—É–ª—å `db` –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é —Ä–∞–±–æ—Ç—É —Å PostgreSQL. –§—É–Ω–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `Result` ‚Äî –æ—à–∏–±–∫–∏ –ë–î –Ω–µ —É–±–∏–≤–∞—é—Ç –±–æ—Ç–∞.

<details>
<summary>üìÑ –ü–æ–ª–Ω—ã–π –∫–æ–¥ db.gleam</summary>

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub ‚Üí](https://github.com/bondiano/gleam-by-example/blob/master/exercises/appendix_a/src/examples/todo_bot/db.gleam)

</details>

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞

–õ–æ–≥–∏–∫—É –±–æ—Ç–∞ –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

```gleam
import gleeunit/should
import app/handlers/todos

// –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–∏—Å—Ç—É—é –ª–æ–≥–∏–∫—É
pub fn format_todo_list_test() {
  todos.format_list([
    Todo(id: 1, title: "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ", completed: False),
    Todo(id: 2, title: "–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã", completed: True),
  ])
  |> should.equal("‚òê 1. –ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ\n‚úÖ 2. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã")
}
```

–î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞ –≤ Telegram ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather).

## –î–µ–ø–ª–æ–π

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
export TELEGRAM_TOKEN="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
export BOT_URL="https://mybot.example.com"
export DB_HOST="localhost"
export DB_NAME="todos_bot"
export SECRET_KEY="your_64_char_secret"
```

–í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚Äî –Ω–∏ –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–¥–µ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–∏—Ç–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ `os.get_env` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ webhook —á–µ—Ä–µ–∑ Telegram API:

```bash
curl -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/setWebhook" \
     -H "Content-Type: application/json" \
     -d '{"url": "https://mybot.example.com/bot"}'
```

Webhook —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è. Telegram –Ω–∞—á–Ω—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å POST-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
curl "https://api.telegram.org/bot$TELEGRAM_TOKEN/getWebhookInfo"
```

–û—Ç–≤–µ—Ç –ø–æ–∫–∞–∂–µ—Ç —Ç–µ–∫—É—â–∏–π URL webhook, —Å—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. –ï—Å–ª–∏ `pending_update_count` —Ä–∞—Å—Ç—ë—Ç ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è

–ö–æ–¥ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `exercises/appendix_a/`.

```bash
cd exercises/appendix_a
gleam test
```

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.1** (–õ—ë–≥–∫–æ–µ): –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞

```gleam
pub type BotCommand {
  CmdStart
  CmdHelp
  CmdList
  CmdAdd(title: String)
  CmdDone(index: Int)
  CmdUnknown(text: String)
}

pub fn parse_command(text: String) -> BotCommand {
  todo
}
```

–†–∞—Å–ø–∞—Ä—Å–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:

- `"/start"` ‚Üí `CmdStart`
- `"/help"` ‚Üí `CmdHelp`
- `"/list"` ‚Üí `CmdList`
- `"/add Buy milk"` ‚Üí `CmdAdd("Buy milk")`
- `"/done 3"` ‚Üí `CmdDone(3)`
- `"/done abc"` ‚Üí `CmdUnknown("/done abc")` (–Ω–µ–ª—å–∑—è –ø–∞—Ä—Å–∏—Ç—å —á–∏—Å–ª–æ)
- –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí `CmdUnknown(text)`

*–ü–æ–¥—Å–∫–∞–∑–∫–∞*: `case string.trim(text) { "/add " <> title -> CmdAdd(title) ... }`, `int.parse(n)` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–∏—Å–ª–∞.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.2** (–õ—ë–≥–∫–æ–µ): –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏

```gleam
pub type Task {
  Task(text: String, done: Bool)
}

pub fn format_task(t: Task) -> String {
  todo
}
```

- `Task("Buy milk", False)` ‚Üí `"‚òê Buy milk"`
- `Task("Write tests", True)` ‚Üí `"‚úÖ Write tests"`

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.3** (–õ—ë–≥–∫–æ–µ): –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á

```gleam
pub fn format_task_list(tasks: List(Task)) -> String {
  todo
}
```

- `[]` ‚Üí `"–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ: /add <–∑–∞–¥–∞—á–∞>"`
- `[task...]` ‚Üí `"–í–∞—à–∏ –∑–∞–¥–∞—á–∏:\n1. ‚òê Buy milk\n2. ‚úÖ Write tests"`

*–ü–æ–¥—Å–∫–∞–∑–∫–∞*: `list.index_map`, `string.join`.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.4** (–°—Ä–µ–¥–Ω–µ–µ): State machine –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞

```gleam
pub type ConvState {
  Idle
  AwaitingTitle
}

pub fn conversation_step(state: ConvState, input: String) -> #(ConvState, String) {
  todo
}
```

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:

- `Idle + "/add"` ‚Üí `#(AwaitingTitle, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:")`
- `Idle + "/help"` ‚Üí `#(Idle, "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/list ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á\n/add ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É\n/help ‚Äî –ø–æ–º–æ—â—å")`
- `Idle + –¥—Ä—É–≥–æ–µ` ‚Üí `#(Idle, "–ù–µ –ø–æ–Ω–∏–º–∞—é. /help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.")`
- `AwaitingTitle + title` ‚Üí `#(Idle, "‚úÖ –ó–∞–¥–∞—á–∞ ¬´title¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞!")`

*–ü–æ–¥—Å–∫–∞–∑–∫–∞*: `case state, string.trim(input) { Idle, "/add" -> ... }`.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.5** (–°—Ä–µ–¥–Ω–µ–µ): –ü–æ–ª–Ω—ã–π dispatch –∫–æ–º–∞–Ω–¥

```gleam
pub fn dispatch(cmd: BotCommand, tasks: List(Task)) -> #(List(Task), String) {
  todo
}
```

–û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã:

- `CmdStart` ‚Üí `#(tasks, "–ü—Ä–∏–≤–µ—Ç! –Ø TODO-–±–æ—Ç.\n/help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥")`
- `CmdHelp` ‚Üí `#(tasks, "–ö–æ–º–∞–Ω–¥—ã:\n/list ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á\n/add <–∑–∞–¥–∞—á–∞> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å\n/done <–Ω–æ–º–µ—Ä> ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ")`
- `CmdList` ‚Üí `#(tasks, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)`
- `CmdAdd(title)` ‚Üí `#([...tasks, Task(title, False)], "‚úÖ –ó–∞–¥–∞—á–∞ ¬´title¬ª –¥–æ–±–∞–≤–ª–µ–Ω–∞!")`
- `CmdDone(n)` ‚Üí –∑–∞–¥–∞—á–∞ `n-1` –ø–æ–º–µ—á–∞–µ—Ç—Å—è `done=True`; –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí `"–ù–µ—Ç –∑–∞–¥–∞—á–∏ —Å –Ω–æ–º–µ—Ä–æ–º n"`
- `CmdUnknown(t)` ‚Üí `#(tasks, "–ù–µ –ø–æ–Ω–∏–º–∞—é: t. /help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥")`

*–ü–æ–¥—Å–∫–∞–∑–∫–∞*: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `format_task_list` –∏–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è A.3.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.6** (–°—Ä–µ–¥–Ω–µ–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ): –ë–æ—Ç —Å —Å–µ—Å—Å–∏—è–º–∏

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π:

- –ü–æ –∫–æ–º–∞–Ω–¥–µ `/counter` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ –∫–æ–º–∞–Ω–¥–µ `/inc` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –Ω–∞ 1
- –ü–æ –∫–æ–º–∞–Ω–¥–µ `/reset` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –≤ 0

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ Telega (`session.attach`). –¢–∏–ø —Å–µ—Å—Å–∏–∏:

```gleam
pub type CounterSession {
  CounterSession(count: Int)
}
```

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å—á—ë—Ç—á–∏–∫, —Ö—Ä–∞–Ω—è—â–∏–π—Å—è –≤ —Å–µ—Å—Å–∏–∏.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.7** (–°–ª–æ–∂–Ω–æ–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ): –ü—Ä–æ—Å—Ç–æ–π Flow –¥–ª—è –æ–ø—Ä–æ—Å–∞

–†–µ–∞–ª–∏–∑—É–π—Ç–µ Flow –¥–ª—è –æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```gleam
type SurveyStep {
  AskName
  AskRating
  AskFeedback
  Thanks
}
```

- `AskName` ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è
- `AskRating` ‚Äî –ø—Ä–æ—Å–∏—Ç –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5 (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É)
- `AskFeedback` ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–∑—ã–≤
- `Thanks` ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç flow

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `flow.wait` –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∏ `flow.wait_callback` –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.8** (–°–ª–æ–∂–Ω–æ–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ): Flow —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π

–†–∞—Å—à–∏—Ä—å—Ç–µ –æ–ø—Ä–æ—Å –∏–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è A.7:

- –ù–∞ —à–∞–≥–µ `AskFeedback` –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ `AskRating`
- –ù–∞ —à–∞–≥–µ `Thanks` –ø–æ–∫–∞–∂–∏—Ç–µ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É:
  - "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ" ‚Üí `flow.goto(ctx, instance, AskName)`
  - "–û—Ç–º–µ–Ω–∏—Ç—å" ‚Üí `flow.cancel(ctx, instance)`

*–ü–æ–¥—Å–∫–∞–∑–∫–∞*: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `flow.is_callback_passed` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.9** (–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ): Flow –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

–†–µ–∞–ª–∏–∑—É–π—Ç–µ Flow –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–æ–ª–∏–∫–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ:

```gleam
type BookingStep {
  CheckRegistration
  CollectDate
  CollectTime
  CollectGuests
  Confirm
  Done
}
```

- `CheckRegistration` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–º–µ–Ω—è–µ—Ç flow —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å: /start"
- `CollectDate` ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç
- `CollectTime` ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (10:00‚Äì22:00)
- `CollectGuests` ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π (1‚Äì10), –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω
- `Confirm` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" –∏ "–û—Ç–º–µ–Ω–∏—Ç—å"
- `Done` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –±—Ä–æ–Ω—å –≤ –ë–î –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ guards –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞, –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤). –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–π—Ç–µ `flow.wait` —Å–Ω–æ–≤–∞, –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥—è –¥–∞–ª—å—à–µ.

---

**–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ A.10** (–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ–µ, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ): TODO-–±–æ—Ç —Å Flow –∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π

–†–∞—Å—à–∏—Ä—å—Ç–µ TODO-–±–æ—Ç–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ü—Ä–æ–µ–∫—Ç":

- –ü—Ä–∏ `/list` –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ "‚úì –í—ã–ø–æ–ª–Ω–∏—Ç—å", "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "üóë –£–¥–∞–ª–∏—Ç—å"
- –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–π—Ç–µ Flow:

  ```gleam
  type EditTodoStep {
    SelectTodo
    EnterNewTitle
    Confirm
  }
  ```

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ subflow –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è (Yes/No)
- –û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ `reply.edit_text`

## –ò—Ç–æ–≥–∏

–ú—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ Telegram-–±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≥–ª–∞–≤:

- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî Gleam –ª–æ–≤–∏—Ç –æ—à–∏–±–∫–∏ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- **Router** ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Session** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Conversation API** ‚Äî –ª–∏–Ω–µ–π–Ω—ã–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —á–µ—Ä–µ–∑ `wait_*` —Ñ—É–Ω–∫—Ü–∏–∏
- **Flow API** ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ FSM —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π
- **Wisp** ‚Äî webhook-—Å–µ—Ä–≤–µ—Ä (–≥–ª–∞–≤–∞ 10)
- **pog** ‚Äî —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL (–≥–ª–∞–≤–∞ 10)
- **Result –∏ use** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–≥–ª–∞–≤–∞ 5)
- **OTP** ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á –≤—Ä–æ–¥–µ rate-limiting (–≥–ª–∞–≤–∞ 8)

Telega ‚Äî –∑—Ä–µ–ª–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –ë–æ—Ç –Ω–∞ Gleam —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ BEAM –∏ –Ω–∞—Å–ª–µ–¥—É–µ—Ç –≤—Å—é –µ–≥–æ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å: –∫—Ä—ç—à –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–±–∏–≤–∞–µ—Ç –≤–µ—Å—å —Å–µ—Ä–≤–µ—Ä. Conversation API –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –¥–∏–∞–ª–æ–≥–æ–≤ –ª–∏–Ω–µ–π–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º, –∞ Flow API –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

## –†–µ—Å—É—Ä—Å—ã

- [HexDocs ‚Äî telega](https://hexdocs.pm/telega/)
- [Telega ‚Äî GitHub](https://github.com/bondiano/telega-gleam)
- [Telega Conversation API ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/bondiano/telega-gleam/blob/master/docs/conversation.md)
- [Telega Flow API ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/bondiano/telega-gleam/blob/master/docs/conversation-flows.md)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Wisp ‚Äî GitHub](https://github.com/gleam-wisp/wisp)
- [HexDocs ‚Äî pog](https://hexdocs.pm/pog/)
